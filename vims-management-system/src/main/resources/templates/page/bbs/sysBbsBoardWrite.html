<article id="sysBbsBoardWritePage" class="gi-article-content gi-col-95 gi-row-100">
    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="gi-margin-bottom-30px gi-padding-left-20px gi-padding-top-20px">
            <h1 class="gi-page-title" id="write-page-title">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.WRITE"]
            </h1>
            <p class="gi-subtitle-main">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.SUB_TITLE_WRITE"]</p>
        </header>

        <article class="gi-padding-left-right-20px">
            <form id="bbsBoardWriteForm">
                <div class="gi-flex gi-flex-column gi-grid-gap-20px">
                    <!-- ì œëª© ìž…ë ¥ -->
                    <div class="gi-input-container gi-flex-1">
                        <label for="board_title" class="gi-input-label" data-focus-label="true"
                            data-required="true">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.TITLE"]</label>
                        <input data-field="title" id="board_title" name="title" class="gi-input" data-required="true"
                            autocomplete="off" />
                    </div>

                    <!-- ìž‘ì„±ìžëª… (ê¸°ë³¸ ë¡œê·¸ì¸ ì •ë³´ ì‚¬ìš© ì˜ˆì •) -->
                    <div class="gi-input-container gi-flex-1">
                        <label for="board_writer" class="gi-input-label"
                            data-focus-label="true">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.WRITER_NAME"]</label>
                        <input data-field="writer_name" id="board_writer" name="writer_name" class="gi-input"
                            autocomplete="off" />
                    </div>

                    <!-- ë‚´ìš© ìž…ë ¥ (Quill Editor ì˜ì—­) -->
                    <div class="gi-flex gi-flex-column gi-grid-gap-10px">
                        <label
                            class="gi-input-label-static">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.CONTENT"]</label>
                        <div id="editor-container" style="height: 400px; background: #fff;"></div>
                        <input type="hidden" data-field="content" id="board_content" name="content" />
                    </div>

                    <!-- íŒŒì¼ ì²¨ë¶€ ì˜ì—­ (file_ynì´ '1'ì¼ ë•Œë§Œ í™œì„±í™”) -->
                    <div id="file-attachment-section" class="gi-article-content gi-margin-top-40px gi-hidden">
                        <div
                            class="gi-flex gi-flex-justify-content-between gi-flex-align-items-end gi-margin-bottom-16px">
                            <div>
                                <h2 class="gi-title-section gi-margin-bottom-4px">
                                    [Page.Message].Message.Label.Array["FILE_ATTACH"]</h2>
                                <p class="gi-text-secondary gi-font-size-14px">
                                    [Page.Message].Message.Label.Array["FILE_ATTACH_INFO"]</p>
                            </div>
                            <button type="button" class="gi-btn-blue" data-file-upload-btn id="file-upload-btn"
                                style="width: 120px;">[Page.Message].Message.Label.Array["UPLOAD_BTN"]</button>
                            <input type="hidden" id="board_file_uuid" data-field="file_uuid" name="file_uuid" />
                        </div>
                        <div id="attached-file-list" class="gi-margin-top-10px"
                            style="min-height: 50px; border: 1px solid #f0f1f7; border-radius: 12px; padding: 16px; background: #f8f9fc;">
                            <div class="gi-file-list-empty">
                                <span class="gi-file-list-empty-icon">ðŸ“‚</span>
                                <p class="gi-file-list-empty-text">
                                    [Page.Message].Message.Label.Array["FILE_ATTACH_AREA_NOT_EXIST_FILE"]</p>
                            </div>
                        </div>
                    </div>
                    <!-- ë²„íŠ¼ ì˜ì—­ -->
                    <div class="gi-flex gi-flex-justify-content-end gi-grid-gap-10px gi-margin-top-20px">
                        <button id="bbs-save-btn" class="gi-btn-blue"
                            type="button">[Page.Message].Message.Label.Array["SAVE_BTN"]</button>
                        <button id="bbs-cancel-btn" class="gi-btn"
                            type="button">[Page.Message].Message.Label.Array["CANCEL_BTN"]</button>
                    </div>
                </div>
            </form>
        </article>
    </section>
</article>

<script type="text/javascript">
    var quill;
    var writeSessionData = JSON.parse(sessionStorage.getItem("DATA"));
    var targetBbsId = writeSessionData.bbs_id;
    var boardId = writeSessionData.board_id; // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ì¡´ìž¬
    var mode = writeSessionData.mode || 'register';

    init();

    async function init() {
        new PageInit();

        // 1. BBS ì„¤ì • í™•ì¸ (íŒŒì¼ ì²¨ë¶€ ê°€ëŠ¥ ì—¬ë¶€ ë“±)
        await checkBbsConfiguration();

        // 2. íŽ˜ì´ì§€ í—¤ë”/íƒ€ì´í‹€ ì„¤ì •
        if (mode === 'modify') {
            $("#write-page-title").text(Message.Label.Array["SYS_BBS_BOARD.TITLE_UPDATE"]);
            $("#bbs-save-btn").text(Message.Label.Array["UPDATE_BTN"]);
        }

        // 3. ì—ë””í„° ì´ˆê¸°í™”
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['image', 'link', 'code-block'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        // 4. ë°ì´í„° ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ)
        if (mode === 'modify' && boardId) {
            fetchBoardData();
        } else {
            // ìž‘ì„±ìž ì´ë¦„ ê¸°ë³¸ê°’ ì„¸íŒ…
            $("#board_writer").val(JwtUtils.getUserEmailFromJWT().split('@')[0]);
        }

        // 5. ë²„íŠ¼ ì´ë²¤íŠ¸
        clickEvent();
    }

    async function checkBbsConfiguration() {
        let url = "/cms/common/sysBbs/find";
        try {
            const response = await axios.post(url, { bbs_id: targetBbsId });
            if (response.status === 200 && response.data.length > 0) {
                let bbsInfo = response.data[0];
                if (bbsInfo.file_yn === '1') {
                    $("#file-attachment-section").removeClass("gi-hidden");
                    initializeFileUtility();
                }
            }
        } catch (e) {
            console.error("BBS Config fetch failed", e);
        }
    }

    function initializeFileUtility() {
        // fileUtil.createFileUpload(API_PATH, UUID_INPUT_ID, FOLDER_NAME)
        fileUtil.createFileUpload("/fms/common/file/sysFileDetail", "board_file_uuid", "bbs_attachments");
    }

    function fetchBoardData() {
        let url = "/cms/common/sysBbsBoard/find";
        axios.post(url, { board_id: boardId }).then(response => {
            if (response.status === 200 && response.data.length > 0) {
                let data = response.data[0];
                $("#board_title").val(data.title);
                $("#board_writer").val(data.writer_name);
                $("#board_file_uuid").val(data.file_uuid).trigger('change');
                quill.root.innerHTML = data.content;
            }
        });
    }

    function clickEvent() {
        // ì €ìž¥/ìˆ˜ì • ë²„íŠ¼
        $("#bbs-save-btn").on("click", function () {
            saveBoard();
        });

        // ì·¨ì†Œ ë²„íŠ¼
        $("#bbs-cancel-btn").on("click", async function () {
            if (await formUtil.confirm(Message.Label.Array["CONFIRM.CANCEL"])) {
                formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: targetBbsId });
            }
        });
    }

    function saveBoard() {
        if (!formUtil.validationCheck("bbsBoardWriteForm", "SYS_BBS_BOARD.CHECK.")) return;

        // ì—ë””í„° ë‚´ìš© ì¶”ì¶œ
        let content = quill.root.innerHTML;
        if (quill.getText().trim().length === 0) {
            formUtil.toast(Message.Label.Array["SYS_BBS_BOARD.CHECK.CONTENT"], "warn");
            return;
        }

        let isUpdate = (mode === 'modify' && boardId);
        let url = isUpdate ? "/cms/common/sysBbsBoard/update" : "/cms/common/sysBbsBoard/register";

        let param = {
            bbs_id: targetBbsId,
            title: $("#board_title").val(),
            content: content,
            writer_name: $("#board_writer").val(),
            file_uuid: $("#board_file_uuid").val()
        };

        if (isUpdate) param.board_id = boardId;

        axios.post(url, param).then(response => {
            if (response.status === 200) {
                formUtil.toast(isUpdate ? Message.Label.Array["COMPLETE.UPDATE"] : Message.Label.Array["COMPLETE.INSERT"], "success");
                formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: targetBbsId });
            }
        }).catch(error => {
            formUtil.toast(Message.Label.Array["FAIL.UPDATE"], "error");
        });
    }
</script>