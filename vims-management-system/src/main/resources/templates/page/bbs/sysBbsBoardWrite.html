<article id="sysBbsBoardWritePage" class="gi-article-content gi-col-95 gi-row-100">
    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <!-- 헤더 영역 -->
        <header class="gi-margin-bottom-30px gi-padding-left-20px gi-padding-top-20px">
            <h1 class="gi-page-title" id="write-page-title">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.WRITE"]
            </h1>
            <p class="gi-subtitle-main">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.SUB_TITLE_WRITE"]</p>
        </header>

        <article class="gi-padding-left-right-20px">
            <form id="bbsBoardWriteForm">
                <div class="gi-flex gi-flex-column gi-grid-gap-20px">
                    <!-- 제목 입력 -->
                    <div class="gi-input-container gi-flex-1">
                        <label for="board_title" class="gi-input-label" data-focus-label="true"
                            data-required="true">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.TITLE"]</label>
                        <input data-field="title" id="board_title" name="title" class="gi-input" data-required="true"
                            autocomplete="off" />
                    </div>

                    <!-- 작성자명 (기본 로그인 정보 사용 예정) -->
                    <div class="gi-input-container gi-flex-1">
                        <label for="board_writer" class="gi-input-label"
                            data-focus-label="true">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.WRITER_NAME"]</label>
                        <input data-field="writer_name" id="board_writer" name="writer_name" class="gi-input"
                            autocomplete="off" />
                    </div>

                    <!-- 내용 입력 (Quill Editor 영역) -->
                    <div class="gi-flex gi-flex-column gi-grid-gap-10px">
                        <label
                            class="gi-input-label-static">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.CONTENT"]</label>
                        <div id="editor-container" style="height: 400px; background: #fff;"></div>
                        <input type="hidden" data-field="content" id="board_content" name="content" />
                    </div>

                    <!-- 파일 첨부 영역 (file_yn이 '1'일 때만 활성화) -->
                    <div id="file-attachment-section" class="gi-hidden" data-file-card data-input-id="board_file_uuid"
                        data-folder-name="bbs_attachments" data-api-path="/fms/common/file/sysFileDetail"
                        data-read-only="false">
                    </div>
                    <!-- 버튼 영역 -->
                    <div class="gi-flex gi-flex-justify-content-end gi-grid-gap-10px gi-margin-top-20px">
                        <button id="bbs-save-btn" class="gi-btn-blue"
                            type="button">[Page.Message].Message.Label.Array["SAVE_BTN"]</button>
                        <button id="bbs-cancel-btn" class="gi-btn"
                            type="button">[Page.Message].Message.Label.Array["CANCEL_BTN"]</button>
                    </div>
                </div>
            </form>
        </article>
    </section>
</article>

<script type="text/javascript">
    var quill;
    var writeSessionData = JSON.parse(sessionStorage.getItem("DATA"));
    var targetBbsId = writeSessionData.bbs_id;
    var boardId = writeSessionData.board_id; // 수정 모드일 때 존재
    var mode = writeSessionData.mode || 'register';

    init();

    async function init() {
        new PageInit();

        // 1. BBS 설정 확인 (파일 첨부 가능 여부 등)
        await checkBbsConfiguration();

        // 2. 페이지 헤더/타이틀 설정
        if (mode === 'modify') {
            $("#write-page-title").text(Message.Label.Array["SYS_BBS_BOARD.TITLE_UPDATE"]);
            $("#bbs-save-btn").text(Message.Label.Array["UPDATE_BTN"]);
            commonTag.inputTagReset(".gi-input");
        }

        // 3. 에디터 초기화
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['image', 'link', 'code-block'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        // 4. 데이터 로드 (수정 모드)
        if (mode === 'modify' && boardId) {
            fetchBoardData();
        } else {
            // 작성자 이름 기본값 세팅
            $("#board_writer").val(JwtUtils.getUserEmailFromJWT().split('@')[0]);
        }

        // 5. 버튼 이벤트
        clickEvent();
    }

    async function checkBbsConfiguration() {
        let url = "/cms/common/sysBbs/find";
        try {
            const response = await axios.post(url, { bbs_id: targetBbsId });
            if (response.status === 200 && response.data.length > 0) {
                let bbsInfo = response.data[0];
                if (bbsInfo.file_yn === '1') {
                    // 조건 충족 시 파일 첨부 영역 활성화
                    await fileUtil.activateFileCard("file-attachment-section");
                }
            }
        } catch (e) {
            console.error("BBS Config fetch failed", e);
        }
    }

    function fetchBoardData() {
        let url = "/cms/common/sysBbsBoard/find";
        axios.post(url, { board_id: boardId }).then(response => {
            if (response.status === 200 && response.data.length > 0) {
                let data = response.data[0];
                $("#board_title").val(data.title);
                $("#board_writer").val(data.writer_name);
                $("#board_file_uuid").val(data.file_uuid).trigger('change');
                quill.root.innerHTML = data.content;
            }
        });
    }

    function clickEvent() {
        // 저장/수정 버튼
        $("#bbs-save-btn").on("click", function () {
            saveBoard();
        });

        // 취소 버튼
        $("#bbs-cancel-btn").on("click", async function () {
            if (await formUtil.confirm(Message.Label.Array["CONFIRM.CANCEL"])) {
                formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: targetBbsId });
            }
        });
    }

    function saveBoard() {
        if (!formUtil.validationCheck("bbsBoardWriteForm", "SYS_BBS_BOARD.CHECK.")) return;

        // 에디터 내용 추출
        let content = quill.root.innerHTML;
        if (quill.getText().trim().length === 0) {
            formUtil.toast(Message.Label.Array["SYS_BBS_BOARD.CHECK.CONTENT"], "warn");
            return;
        }

        let isUpdate = (mode === 'modify' && boardId);
        let url = isUpdate ? "/cms/common/sysBbsBoard/update" : "/cms/common/sysBbsBoard/register";

        let param = {
            bbs_id: targetBbsId,
            title: $("#board_title").val(),
            content: content,
            writer_name: $("#board_writer").val(),
            file_uuid: $("#board_file_uuid").val()
        };

        if (isUpdate) param.board_id = boardId;

        axios.post(url, param).then(response => {
            if (response.status === 200) {
                formUtil.toast(isUpdate ? Message.Label.Array["COMPLETE.UPDATE"] : Message.Label.Array["COMPLETE.INSERT"], "success");
                formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: targetBbsId });
            }
        }).catch(error => {
            formUtil.toast(Message.Label.Array["FAIL.UPDATE"], "error");
        });
    }
</script>