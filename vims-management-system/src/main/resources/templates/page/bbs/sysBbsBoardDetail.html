<article id="sysBbsBoardDetailPage" class="gi-article-content gi-col-95 gi-row-100">
    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <!-- Ìó§Îçî ÏòÅÏó≠ -->
        <header class="gi-margin-bottom-30px gi-padding-left-20px gi-padding-top-20px">
            <h1 class="gi-page-title" id="detail-board-title">[Page.Message].Message.Label.Array["SYS_BBS_BOARD.DETAIL"]
            </h1>
            <div class="gi-flex gi-flex-justify-content-between gi-flex-align-items-center gi-margin-top-10px">
                <div class="gi-flex gi-grid-gap-20px gi-text-secondary">
                    <span>[Page.Message].Message.Label.Array["SYS_BBS_BOARD.WRITER"]: <b id="detail-writer"
                            class="gi-color-black"></b></span>
                    <span>[Page.Message].Message.Label.Array["SYS_BBS_BOARD.DATE"]: <b id="detail-date"
                            class="gi-color-black"></b></span>
                    <span>[Page.Message].Message.Label.Array["SYS_BBS_BOARD.HIT"]: <b id="detail-hit"
                            class="gi-color-black">0</b></span>
                </div>
            </div>
        </header>

        <article class="gi-padding-left-right-20px">
            <hr class="gi-margin-bottom-30px" style="border: 0; border-top: 1px solid #eee;" />

            <!-- Î≥∏Î¨∏ ÎÇ¥Ïö© -->
            <div class="ql-container ql-snow"
                style="border: none; background: #fff; border-radius: 8px; border: 1px solid #efefef;">
                <div id="detail-content" class="gi-padding-20px ql-editor"
                    style="min-height: 300px; color: #333 !important;">
                    <!-- Í≤åÏãúÍ∏Ä Î≥∏Î¨∏ ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê Î°úÎìúÎê©ÎãàÎã§. -->
                </div>
            </div>

            <!-- Ï≤®Î∂Ä ÌååÏùº ÏòÅÏó≠ -->
            <div id="detail-file-section"></div>

            <!-- ÌïòÎã® Î≤ÑÌäº -->
            <div
                class="gi-flex gi-flex-justify-content-center gi-grid-gap-20px gi-margin-top-40px gi-margin-bottom-20px">
                <button id="detail-list-btn"
                    class="gi-btn gi-flex gi-flex-align-items-center gi-flex-justify-content-center"
                    style="width: 90px; height: 20px;" type="button">
                    <img src="/common/img/back-white.png" style="width: 20px;" alt="Î™©Î°ùÏúºÎ°ú">
                </button>
                <button id="detail-update-btn"
                    class="gi-btn-blue gi-flex gi-flex-align-items-center gi-flex-justify-content-center"
                    style="width: 90px; height: 20px;" type="button">
                    <img src="/common/img/pen-white.png" style="width: 20px;" alt="ÏàòÏ†ï">
                </button>
                <button id="detail-delete-btn"
                    class="gi-btn-red gi-flex gi-flex-align-items-center gi-flex-justify-content-center"
                    style="width: 90px; height: 20px;" type="button">
                    <img src="/common/img/trash-white.png" style="width: 20px;" alt="ÏÇ≠Ï†ú" />
                </button>
            </div>
        </article>
    </section>
</article>

<script type="text/javascript">
    var detailSessionData = JSON.parse(sessionStorage.getItem("DATA"));
    var boardId = detailSessionData.board_id;
    var bbsId = detailSessionData.bbs_id;

    init();

    async function init() {
        new PageInit();
        await fileUtil.loadFileCard("detail-file-section", { inputId: "board_file_uuid", isReadOnly: true });
        fetchBoardDetail();
        clickEvent();
    }

    function clickEvent() {
        $("#detail-list-btn").on("click", function () {
            formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: bbsId });
        });

        $("#detail-update-btn").on("click", function () {
            formUtil.apiLoadContent("cms", "/bbs/sysBbsBoardWrite", { ...detailSessionData, mode: 'modify' });
        });

        $("#detail-delete-btn").on("click", async function () {
            if (await formUtil.confirm(Message.Label.Array["CONFIRM.DELETE"])) {
                deleteBoard();
            }
        });
    }

    function fetchBoardDetail() {
        let url = "/cms/common/sysBbsBoard/find";
        axios.post(url, { board_id: boardId }).then(response => {
            if (response.status === 200 && response.data && response.data.length > 0) {
                let data = response.data[0];
                $("#detail-board-title").text(data.title || "Ï†úÎ™© ÏóÜÏùå");
                $("#detail-writer").text(data.writer_name || "Ïïå Ïàò ÏóÜÏùå");

                // API ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ ÏßÅÏ†ë ÏÇ¨Ïö©
                $("#detail-date").text(data.system_create_date || "-");
                $("#detail-hit").text(data.hit_count || 0);

                if (data.content && data.content.trim() !== "") {
                    $("#detail-content").html(data.content).css("color", "#333");
                } else {
                    $("#detail-content").html("<p style='color:#999; text-align:center; margin-top:100px;'>" + Message.Label.Array["FAIL.SELECT_NO_DATA"] + "</p>");
                }

                // Ï≤®Î∂Ä ÌååÏùº Ï°∞Ìöå
                if (data.file_uuid) {
                    fetchAttachedFiles(data.file_uuid);
                }
            } else {
                formUtil.toast(Message.Label.Array["FAIL.SELECT_NO_DATA"], "error");
            }
        });
    }

    function fetchAttachedFiles(fileUuid) {
        let url = "/fms/common/file/sysFileDetail/find";
        axios.post(url, { file_uuid: fileUuid }).then(response => {
            if (response.status === 200 && response.data.length > 0) {
                $("#detail-file-section").removeClass("gi-hidden");
                renderFiles(response.data);
            }
        });
    }

    function renderFiles(files) {
        let html = '<div class="gi-file-list-container">';
        files.forEach((file, index) => {
            const extension = (file.file_extension || '').toLowerCase();
            let typeClass = "";

            if (['pdf', 'hwp', 'doc', 'docx'].includes(extension)) typeClass = "gi-file-type-doc";
            else if (['xls', 'xlsx', 'csv'].includes(extension)) typeClass = "gi-file-type-xls";
            else if (['zip', 'rar', '7z'].includes(extension)) typeClass = "gi-file-type-zip";
            else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) typeClass = "gi-file-type-img";

            html += `
                <div class="gi-file-item-card" style="cursor: pointer;" onclick="downloadFile('${file.file_id}', '${file.file_name_with_ext}')">
                    <div class="gi-file-badge-no">${index + 1}</div>
                    <div class="gi-file-icon-box ${typeClass}">üìÑ</div>
                    <div class="gi-file-info">
                        <span class="gi-file-name" title="${file.file_name}">${file.file_name}</span>
                        <div class="gi-file-meta">
                            <span class="gi-file-size-tag">${formUtil.formatBytes(file.file_size)}</span>
                            <span class="gi-file-ext-tag ${typeClass}" style="background: none;">${extension}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        $("#detail-file-list").html(html);
    }

    // ÌååÏùº Îã§Ïö¥Î°úÎìú Ìï®Ïàò (Ï∂îÍ∞Ä ÌïÑÏöî Ïãú Íµ¨ÌòÑ)
    window.downloadFile = function (fileId, fileName) {
        // Ïã§Ï†ú Îã§Ïö¥Î°úÎìú Î°úÏßÅÏùÄ ÌîÑÎ°úÏ†ùÌä∏Ïùò ÌååÏùº Îã§Ïö¥Î°úÎìú APIÏóê ÎßûÏ∂∞ Íµ¨ÌòÑ
        console.log("Downloading:", fileId, fileName);
        // Ïòà: window.location.href = `/fms/fileManager/download?fileId=${fileId}`;
    };

    function deleteBoard() {
        let url = "/cms/common/sysBbsBoard/remove";
        axios.post(url, { board_id: boardId }).then(response => {
            if (response.status === 200) {
                formUtil.toast(Message.Label.Array["COMPLETE.DELETE"], "success");
                formUtil.apiLoadContent("cms", "/bbs/view", { bbs_id: bbsId });
            }
        });
    }
</script>